# 詳細設計書（mictylish MVP）
## 1. 全体構成
- Frontend: Lexer / Parser / NameResolver
- Core: Value / Error / Pattern / AST
- Runtime: Stream 実行、Builtins、外部プロセス連携
- Shell UI: REPL、スクリプト実行、診断表示
## 2. モジュール設計（現行コード準拠）
- `src/ast.rs`: AST ノード定義
- `src/value.rs`: `Value` モデル
- `src/error.rs`: `miette` 診断連携エラー
- `src/resolver.rs`: シャドウイング禁止の名前解決
- `src/command.rs`: 安全な外部コマンド仕様（program + args）
- `src/runtime.rs`: コマンド実行ブリッジ
- `src/builtin.rs`: `glob(...)` 等の組み込み
- `src/repl.rs`: `rustyline` ベース REPL
## 3. 構文設計（MVP）
- `let name = expr`
- `|>`（関数合成）
- `fn x -> expr end`
- `match expr do ... end`
- `with pat <- expr, ... do ... else ... end`
- `io do ... end`
## 4. 名前解決規則
- 変数定義時に全外側スコープを検索
- 同名が存在したら定義エラー（再束縛・シャドウイング禁止）
- エラーには「既存定義位置」と「再定義位置」の両 span を含める
## 5. 外部コマンド仕様
- 実行 API は `CommandSpec { program, args }`
- 引数は配列で保持し、OS API にそのまま渡す
- 文字列連結によるシェル解釈実行を標準 API から除外
## 6. エラーモデル
- Parse / Name / Exec / IO などを段階的に定義
- CLI 表示は `miette` で span と補足説明を出す
- 実行時失敗は Result 経由で返す
## 7. テスト戦略（MVP）
- 名前衝突が拒否されること
- glob が明示呼び出しでのみ展開されること
- `"a b"` が 1 引数のまま渡ること
